### 传统博彩行业的弊端

传统的博彩行业开奖是中心化的，由一个具有较大信任度的机构(赌场)
在约定好的时刻按照约定好的规则(如掷骰子,计算机生成随机数)进行开奖，
但是由于开奖过程不是`公开的`，所以内部可能存在黑箱操作的嫌疑。

### 区块链解决方案

为了解决这个问题，这里提出了一种结合了区块链技术的博彩算法，可以实现一个
开奖结果公开透明、不可篡改、可验证、不可操控、不可预测的去中心化的在线博彩平台。


### 分析与结论

- 分析

1. 区块链本质上是一个状态复制机，不同计算设备对区块链的所有历史数据进行重放，并保持状态一致，
如果进行重放的过程中交易需要计算设备自主生成随机数，这就要求该随机数发生器在每台设备上运行结果相同，
否则无法验证通过，区块链数据将被认为是无效的，无法达成共识。因此，在区块链上，随机性的引入必然和计算设备无关。

2. 区块链上的随机数发生器如果只有一个参与方，那么该参与方相对其他人可以提前知道即将生成的随机数，
无法保证公平。如果是多人合作生成，则必然存在最后一个参与者，该参与者可以提前知道即将生成的随机数，
那么可以通过遍历所有可能的幸运号码的方式来选择一个最优的幸运号码。

- 结论

1. 随机性应该来源于博彩的参与者，参与者的参与的顺序、提交的内容都是真随机的，具有足够的熵源
2. 为了防止最后一个参与者通过遍历所有可能的幸运号码的方式来选择一个最优的幸运号码，
解决的措施是二次提交。


### 安全随机数构造算法
主要分3阶段
1. 在指定的时间之前，收集参与者提交的hash(s), s为每个参与者提供的随机种子.
2. 在指定的时间之前，收集参与者的s，并用相应的hash(s)进行验证,合格则加入随机种子列表list.
3. 以 f(list) 作为最终的随机数.

### 具体实现

为了简化业务逻辑，以及提供更好的用户体验，我将整个业务流程进行解耦（下面的时间段选定仅仅
只是为了让该过程更加具体，易于理解，并不是设计规范)
- 购买幸运号码：

在指定的时间之前如每天12:00之前，参与者可以用一定的筹码购买一个幸运号码,这个信息对外公开，
12:00之后购买号码的交易系统将关闭
- 提交加密后的种子（可选）：

在每天的14:00之前，之前购买过幸运号码的玩家，`可以`提交一份种子的hash值，
提交的种子来源与参与者，参与者是随机的，那么最终的结果也就是随机的
- 提交种子（可选)：

在每天的14:00~19:00时间段内，每位参与者可提交一份种子，该种子的hash值必须为之前提交的hash
- 开奖

19:00~20:00时间段为等待时间，20:00将进行开奖，开奖结果依赖`所有参与者的幸运号码、还有第三提交的种子如果有的话，否则为第二次
提交的hash值`，都作为最终的随机数生成种子。

- 分奖

根据每个参与者筹码数目，压得多、输或赢变化大，在根据每个参与者买的幸运号码与最终幸运号码的匹配程度
，越匹配得到的回报越多，否则，相应的越少。分奖结束后，可开启下一轮开奖。

### 总结

- 公开透明性: 所有参与者的交易数据完全公开，开奖算法公开。
- 可验证性: 其实在19:00~20:00这段等待时间内参与者就已经可以根据公开的算法和所有参与者的输入信息得出开奖结果.
- 不可预测性: 参与者在购买完幸运数字后，在每天14:00之前就还有机会,可以提交一段经hash加密后的种子，用于增强最终开奖结果的随机性.
因为hash算法是逆向困难的，目前在有限的时间内无法找到其解，而且SHA-3的出现，将使得hash加密更加安全。
所以只要至少存在二个加密的种子，那么对于任何人来说最终的开奖结果就是不可预测的
- 公平性: 因为对于任何人来说最终的开奖结果是不可预测的，随机的，而随机源有分别来自每位随机的参与者，
所有具有公平性。
- 不可篡改：当一位参与者提交好经hash加密后的种子后，就不可伪造一个新的种子，
区块链保技术证了提交好后的加密种子无法被篡改，所以伪造的种子将验证失败而被拒绝。

### 限制

1. 每个幸运号码只能被购买一次，先购买者先得
2. 只有参与者才可以选择提交加密后的种子

### 用户体验
1. 因为购买幸运号码和提交随机数种子两个业务之间并没有什么关系，且幸运号码是明文提交的，
所以参与者购买的幸运号码的长度位可以设定在8位
2. 对于普通的用户，只需要在规定的时间前购买幸运号码参与开奖即可，不必关心提交加密种子这件事情，
对于有条件的用户，用户可以选择提交加密种子，保证随机性，当然用户如果完全信任联盟中的组织，那么可以
仅仅由联盟中所有的组织来提交加密种子保证开奖结果的不可预测性。

### 区块链技术选用

**对技术不太关心，可以跳过**

首先区块链技术的底层组件选用IBM领衔开发的`Hyper Ledger Fabric`，
> 正如Hyperledger官方网站上的描述，这一项目的目标是发展一个跨行业的开放式标准以及开源代码开发库，允许企业创建自定义的分布式账本解决方案，以促进区块链技术在商业当中的应用。

这个开源代码库已经实现了区块链技术的基本组件
- `gossip`协议，gossip协议是基于p2p协议的

[gossip 协议介绍](https://www.jianshu.com/p/3aa9a109072c)

- 以及`GRPC`通讯规范，

[grpc 协议介绍](https://www.jianshu.com/p/70d9f3f2b645)

- `系统链码`(也称内置的智能合约) 以及`cscc`,`lscc`,`escc`,`vscc`,`qscc`等

[system chain code 介绍](https://blog.csdn.net/idsuf698987/article/details/76130699)

- 还有各种组件，如`TLS通讯协议`、`cipher组件`、数据库组件`leveldb`和`couchdb`的适配、以及orderer间的共识算法
solo，kafka，spft等等，或者自定义。

[hyperledger fabirc 共识介绍](https://www.jianshu.com/p/daa9f0e7c3f5)

